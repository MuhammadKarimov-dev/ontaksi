{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">Yangi foydalanuvchi qo'shish</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="addUserForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="username" class="form-label">Login</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon raqam</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="phone" name="phone" 
                                       placeholder="+998901234567" required>
                                <button type="button" class="btn btn-info" id="sendSmsBtn">
                                    <i class="bi bi-telegram"></i> Telegramga yuborish
                                </button>
                            </div>
                            <div id="smsStatus" class="form-text"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Parol</label>
                            <input type="text" class="form-control" id="password" name="password" 
                                   value="{{ generated_password }}" required>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="saveBtn" disabled>
                                <i class="bi bi-person-plus"></i> Saqlash
                            </button>
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Orqaga
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    const sendSmsBtn = document.getElementById('sendSmsBtn');
    const saveBtn = document.getElementById('saveBtn');
    const smsStatus = document.getElementById('smsStatus');
    
    // SMS yuborish
    sendSmsBtn.addEventListener('click', async function() {
        sendSmsBtn.disabled = true;
        smsStatus.textContent = "Xabar yuborilmoqda...";
        smsStatus.className = "form-text text-info";
        
        try {
            const response = await fetch('{% url "send_verification_sms" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    phone: phoneInput.value,
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                })
            });
            
            const data = await response.json();
            if (data.success) {
                smsStatus.textContent = "Xabar muvaffaqiyatli yuborildi!";
                smsStatus.className = "form-text text-success";
                saveBtn.disabled = false;
            } else {
                smsStatus.textContent = data.error;
                smsStatus.className = "form-text text-danger";
                sendSmsBtn.disabled = false;
            }
        } catch (error) {
            smsStatus.textContent = "Xatolik yuz berdi. Qayta urinib ko'ring";
            smsStatus.className = "form-text text-danger";
            sendSmsBtn.disabled = false;
        }
    });
});
</script>
{% endblock %} 